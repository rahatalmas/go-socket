<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>WebSocket Streaming Chat</title>
<style>
  body { font-family: Arial, sans-serif; }
  #chat-container {
    border: 1px solid #ccc;
    padding: 10px;
    width: 600px;
    height: 400px;
    overflow-y: auto;
    background: #f9f9f9;
    display: flex;
    flex-direction: column;
  }
  .bubble {
    padding: 8px 12px;
    margin: 4px 0;
    border-radius: 12px;
    max-width: 80%;
    white-space: pre-wrap; /* preserves line breaks */
  }
  .bubble.user {
    background-color: #007bff;
    color: white;
    align-self: flex-end;
  }
  .bubble.ai {
    background-color: #e0e0e0;
    color: black;
    align-self: flex-start;
  }
  .bubble.ai.typing::after {
    content: '|';
    animation: blink 1s infinite;
    margin-left: 2px;
  }
  @keyframes blink {
    0%,50%,100%{opacity:1}
    25%,75%{opacity:0}
  }
  pre { background: #333; color: #f8f8f2; padding: 8px; border-radius: 6px; overflow-x: auto; }
  code { font-family: monospace; }
</style>
</head>
<body>

<h2>Streaming Chat Client</h2>

<div>
  <label>Server URL:</label><br/>
  <input id="wsUrl" type="text" size="60" 
    value="ws://localhost:4646/ws?customer_id=123&company_id=abc&source=web" /><br/><br/>
  <button onclick="connect()">Connect</button>
  <button onclick="disconnect()">Disconnect</button>
</div>

<hr/>

<div>
  <label>Message:</label><br/>
  <textarea id="message" rows="4" cols="60"></textarea><br/>
  <button onclick="sendMessage()">Send</button>
</div>

<hr/>
<h3>Chat</h3>
<div id="chat-container"></div>

<hr/>
<h3>Logs</h3>
<pre id="log"></pre>

<script>
let socket = null;
let currentAIBubble = null;

function log(msg) {
  const logEl = document.getElementById("log");
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

// --- WebSocket Connection ---
function connect() {
  const url = document.getElementById("wsUrl").value;
  socket = new WebSocket(url);

  socket.onopen = () => log("Connected");
  socket.onclose = (e) => {
    log(`Disconnected (code=${e.code}, reason=${e.reason})`);
    currentAIBubble = null;
  };
  socket.onerror = (err) => {
    log("WebSocket error"); console.error(err);
  };
  socket.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    handleMessage(msg);
  };
}

function disconnect() {
  if (socket) { socket.close(); socket = null; }
}

// --- Send User Message ---
function sendMessage() {
  if (!socket || socket.readyState !== WebSocket.OPEN) {
    log("Not connected"); return;
  }

  const text = document.getElementById("message").value.trim();
  if (!text) return;

  const payload = {
    type: "message",
    payload: {
      sender_type: "customer",
      content: text,
      content_type: "text",
      created_at: new Date().toISOString()
    }
  };
  socket.send(JSON.stringify(payload));
  log("ðŸ“¤ Sent: " + JSON.stringify(payload));

  createChatBubble("user", text);
  document.getElementById("message").value = "";
}

// --- Handle Streaming AI Messages ---
function handleMessage(msg) {
  switch(msg.type) {
    case "typing_start":
      currentAIBubble = createChatBubble("AI-AGENT", "", true);
      break;
    case "message_chunk":
      if (currentAIBubble) appendToBubble(currentAIBubble, msg.payload.content);
      break;
    case "typing_end":
      if (currentAIBubble) { finishBubble(currentAIBubble); currentAIBubble = null; }
      break;
    case "error":
      alert("AI Error: " + msg.payload.error);
      break;
    default:
      log("Unknown WS type: " + msg.type);
  }
}

// --- Chat Bubble Helpers ---
function createChatBubble(sender, text, typing=false) {
  const container = document.getElementById("chat-container");
  const bubble = document.createElement("div");
  bubble.className = `bubble ${sender==="AI-AGENT"?"ai":"user"}${typing?" typing":""}`;
  bubble.innerHTML = text;
  container.appendChild(bubble);
  container.scrollTop = container.scrollHeight;
  return bubble;
}

// Format incoming AI text (code blocks, lists)
function appendToBubble(bubble, text) {
  bubble.innerHTML += formatAIContent(text);
  bubble.parentElement.scrollTop = bubble.parentElement.scrollHeight;
}

function finishBubble(bubble) { bubble.classList.remove("typing"); }

function formatAIContent(text) {
  // Escape HTML first
  text = text.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  
  // Code blocks ```go ... ```
  text = text.replace(/```(.*?)\n([\s\S]*?)```/g, (_, lang, code) =>
    `<pre><code class="${lang}">${code}</code></pre>`
  );

  // Bullet points
  if (/- /.test(text)) {
    text = text.replace(/^- (.*)$/gm, '<li>$1</li>');
    text = '<ul>' + text + '</ul>';
  }

  // Line breaks
  text = text.replace(/\n/g, '<br>');
  return text;
}
</script>
</body>
</html>
